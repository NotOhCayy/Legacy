<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Incident Tools — Calculator + Robbery</title>
  <style>
    :root{--bg:#0b0f16;--card:#111826;--muted:#93a1b1;--text:#e6edf3;--accent:#3b82f6;--line:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0e1624,#0b0f16)}
    header h1{margin:0;font-size:20px}
    header p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .tabs{display:flex;gap:8px;padding:10px 16px;border-bottom:1px solid var(--line);background:#0d1422}
    .tab{padding:8px 12px;border:1px solid var(--line);border-bottom:none;border-radius:10px 10px 0 0;background:#0b1220;color:#cbd5e1;cursor:pointer}
    .tab.active{background:var(--accent);border-color:#2f66c5;color:#fff}
    main{padding:16px;max-width:1300px;margin:0 auto}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:14px;color:#cbd5e1}
    .section{padding:12px 14px}
    input,select,button,textarea{font:inherit}
    input[type=text], input[type=number], select, textarea{width:100%;padding:8px 10px;border:1px solid #243042;background:#0d1422;color:var(--text);border-radius:10px}
    input::placeholder, textarea::placeholder{color:#64748b}
    .row{display:flex;gap:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .muted{color:var(--muted)}
    .btn{background:#0d1422;border:1px solid #20304d;color:#cbd5e1;border-radius:10px;padding:7px 10px;cursor:pointer}
    .btn:hover{border-color:#335a99}
    .btn-primary{background:var(--accent);border-color:#2f66c5;color:#fff}
    .sticky-footer{display:flex;gap:8px;justify-content:flex-end;padding:10px;border-top:1px solid var(--line);background:#0e1624;position:sticky;bottom:0}
    .cols{display:grid;grid-template-columns:330px 1fr;gap:16px}
    @media (max-width:1000px){.cols{grid-template-columns:1fr}}
    .charges-list{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px}
    .charge-item{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px dashed var(--line)}
    .code{font-weight:600;color:#93c5fd}
    .def{color:#93a1b1;font-size:12px}
    .tag{display:inline-block;font-size:11px;padding:2px 6px;border-radius:6px;border:1px solid var(--line);background:#0d1422;margin-right:6px;margin-top:4px}
    .selected-list{max-height:280px;overflow:auto;border:1px solid var(--line);border-radius:10px}
    .selected-row{display:grid;grid-template-columns:86px 1fr 100px 120px 70px 30px;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px dashed var(--line)}
    .sum{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
    .card{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:10px}
    .small{font-size:12px}
    .rf-grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    @media (max-width:1000px){.rf-grid{grid-template-columns:1fr}}
    textarea#report, textarea#robReport{height:260px;white-space:pre-wrap}
  </style>
</head>
<body>
<header>
  <h1>Incident Tools</h1>
  <p class="muted">Single-file app: Charge Calculator + Robbery Incident Report. Dropdown names, autosave, URL prefill.</p>
</header>
<div class="tabs">
  <button class="tab active" data-tab="calc">Incident Charge Calculator</button>
  <button class="tab" data-tab="rob">Robbery Incident Report</button>
</div>
<main>
  <!-- CALCULATOR -->
  <section id="tab-calc" class="panel">
    <h2>Charge Calculator</h2>
    <div class="section">
      <div class="cols">
        <aside>
          <div class="section" style="padding:0 0 12px 0">
            <input id="search" type="text" placeholder="Search code or name (e.g., 304, Robbery)" />
            <div class="charges-list" id="catalog" style="margin-top:8px"></div>
          </div>
          <h3 class="muted" style="margin:8px 0 6px">Enhancements</h3>
          <div class="section" id="enhancements" style="padding:0"></div>
          <div class="section" style="padding:12px 0 0">
            <button id="clearAll" class="btn">Clear selection</button>
            <button id="shareLink" class="btn">Share prefilled link</button>
          </div>
        </aside>
        <div>
          <div class="grid2">
            <select id="officerSelect"><option value="">Select callsign — name…</option></select>
            <input id="officer" type="text" placeholder="Officer/Callsign (editable)" />
          </div>
          <div class="selected-list" id="selected" style="margin-top:12px"></div>
          <div class="sum">
            <div class="card"><div class="muted small">Total Time</div><div id="sumTime" style="font-size:18px"></div></div>
            <div class="card"><div class="muted small">Total Fine</div><div id="sumFine" style="font-size:18px"></div></div>
            <div class="card"><div class="muted small">Total Points</div><div id="sumPoints" style="font-size:18px"></div></div>
            <div class="card"><div class="muted small">Flags</div><div id="sumFlags" class="small"></div></div>
          </div>
          <h3 style="margin:14px 0 6px">Report</h3>
          <div class="grid2">
            <input id="suspect" type="text" placeholder="Suspect name (optional)" />
          </div>
          <textarea id="report" class="card" placeholder="Generated report will appear here..."></textarea>
          <div class="sticky-footer">
            <button id="copy" class="btn">Copy</button>
            <button id="print" class="btn">Print</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ROBBERY -->
  <section id="tab-rob" class="panel" style="display:none">
    <h2>Robbery Incident Report</h2>
    <div class="section rf-grid">
      <aside>
        <div class="grid2">
          <select id="robOfficerSel"><option value="">Select callsign — name…</option></select>
          <input id="robOfficer" type="text" placeholder="Your Callsign & Name (editable)" />
        </div>
        <div class="grid2" style="margin-top:8px">
          <select id="sceneCmd"><option value="">Scene command…</option></select>
          <select id="negotiator"><option value="">Negotiator…</option></select>
        </div>
        <select id="hostageBack" style="margin-top:8px"><option value="">Who stayed back for hostage…</option></select>

        <h3 style="margin:14px 0 6px">Pursuit Order</h3>
        <div class="grid2"><select id="primary"><option value="">Primary…</option></select><select id="primaryPass"><option value="">Passenger…</option></select></div>
        <div class="grid2" style="margin-top:6px"><select id="secondary"><option value="">Secondary…</option></select><select id="secondaryPass"><option value="">Passenger…</option></select></div>
        <div class="grid2" style="margin-top:6px"><select id="tertiary"><option value="">Tertiary…</option></select><select id="tertiaryPass"><option value="">Passenger…</option></select></div>
        <div class="grid2" style="margin-top:6px"><select id="parallel"><option value="">Parallel…</option></select><select id="parallelPass"><option value="">Passenger…</option></select></div>
        <div class="grid2" style="margin-top:6px"><input id="bike" placeholder="Bike-Unit (Optional)" /><input id="air1" placeholder="Air-1 (Optional)" /></div>
        <input id="air1Copilot" placeholder="Co-Pilot (Optional)" style="margin-top:6px" />

        <h3 style="margin:14px 0 6px">Robbery</h3>
        <div class="row" role="radiogroup" aria-label="Robbery Type">
          <label><input type="radio" name="robType" value="Jewelry Store"> Jewelry Store</label>
          <label><input type="radio" name="robType" value="Fleeca Bank"> Fleeca Bank</label>
          <label><input type="radio" name="robType" value="24/7 Store"> 24/7 Store</label>
        </div>
        <select id="whichFleeca" style="margin-top:8px;display:none">
          <option value="">Which Fleeca…</option>
          <option>Legion Square</option><option>Burton</option><option>Rockford Hills (Lifeinvader)</option><option>Alta</option><option>Great Ocean</option><option>Route 68</option>
        </select>
        <select id="which247" style="margin-top:8px;display:none">
          <option value="">Which 24/7…</option>
          <option>Strawberry 24/7</option><option>Davis LTD 24/7</option><option>Murrieta Heights Rob's Liquor</option><option>Little Seoul LTD 24/7</option><option>Vespucci Canals Rob's Liquor</option><option>Morningwood Rob's Liquor</option><option>Mirror Park LTD 24/7</option><option>Downtown Vinewood 24/7</option><option>Tataviam Mountains 24/7</option><option>Banham Canyon Rob's Liquor</option><option>Banham Canyon 24/7</option><option>Richman Glen LTD 24/7</option><option>Chumash 24/7</option><option>Harmony 24/7</option><option>Grand Senora 24/7</option><option>Grapeseed LTD 24/7</option><option>Mount Chilliad 24/7</option>
        </select>

        <div class="grid3" style="margin-top:8px">
          <label>Inside
            <select id="robInside"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select>
          </label>
          <label>Outside
            <select id="robOutside"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select>
          </label>
          <label>Hostages
            <select id="hostages"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>
          </label>
        </div>

        <div style="margin-top:8px">
          <div class="muted" style="margin-bottom:4px">Demands</div>
          <label><input type="checkbox" class="demand" value="free passage with no spikes on perimeter"> free passage with no spikes on perimeter</label><br>
          <label><input type="checkbox" class="demand" value="free passage with no spikes on the whole chase"> free passage with no spikes on the whole chase</label><br>
          <label><input type="checkbox" class="demand" value="no helicopter"> no helicopter</label><br>
          <label><input type="checkbox" class="demand" value="no speed unit"> no speed unit</label><br>
          <label><input type="checkbox" class="demand" value="no bike unit"> no bike unit</label><br>
          <input id="demandOther" placeholder="Other (optional)" />
        </div>

        <h3 style="margin:14px 0 6px">Vehicle</h3>
        <input id="vehDesc" placeholder="Description" />
        <div class="grid3" style="margin-top:8px">
          <input id="vehColor" placeholder="Color" />
          <input id="vehPlate" placeholder="Plate" />
          <input id="vehRegTo" placeholder="Registered To" />
        </div>

        <h3 style="margin:14px 0 6px">Outcome</h3>
        <select id="ending"><option value="">How did the chase end?</option></select>
        <label style="margin-top:6px;display:block"><input id="caughtOnly" type="checkbox" /> Check this once they have been caught only!</label>
        <textarea id="endingCustom" placeholder="Write Custom Ending (optional)" style="margin-top:8px;height:92px"></textarea>

        <h3 style="margin:14px 0 6px">Medical & Processing</h3>
        <label><input id="medNeeded" type="checkbox"/> Medical attention needed</label>
        <div class="grid3" style="margin-top:6px">
          <label>Suspects <select id="medSus"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></label>
          <label>Police <select id="medCop"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></label>
          <label>Hospital <select id="hospital"><option>Saint Fiacre</option><option>Mount Zonah</option><option>Sandy Shores Medical</option><option>Paleto Hospital</option><option>Cayo Perico</option></select></label>
        </div>
        <label style="margin-top:6px;display:block"><input id="fleeHospital" type="checkbox"/> Attempted to flee at hospital</label>
        <div class="grid2" style="margin-top:8px">
          <select id="processedAt"><option>MRPD</option><option>Sandy Shores Sheriff's Office</option><option>Davis PD</option><option>Paleto Police Department</option><option>Highway Police Department</option></select>
          <label style="display:flex;align-items:center;gap:6px"><input id="pleadNC" type="checkbox"/> Plead no contest (optional)</label>
        </div>
      </aside>

      <section>
        <textarea id="robReport" class="card" placeholder="The report will appear here as you fill the form…"></textarea>
        <div class="sticky-footer">
          <button id="robShare" class="btn">Share prefilled link</button>
          <button id="robCopy" class="btn">Copy</button>
          <button id="robPrint" class="btn">Print</button>
        </div>
      </section>
    </div>
  </section>
</main>

<script>
/**************** OFFICERS ****************/ 
const OFFICERS=[
  {cs:'X-100',name:'Curtis Roscoe'},{cs:'X-101',name:'Alexander Murphy'},
  {cs:'A-110',name:'Maya Serrano'},{cs:'A-111',name:'Max Callahan'},{cs:'A-112',name:'Alexandr Nolan'},{cs:'A-115',name:'Pepper Belle'},{cs:'A-118',name:'Oscar Deacon'},
  {cs:'C-123',name:'Hayley Cassidy'},{cs:'C-134',name:'Jason Brennon'},
  {cs:'LT-129',name:'Quintin Johnson'},{cs:'LT-141',name:'Valentina Reyes'},{cs:'LT-151',name:'Hamidi Aziz'},{cs:'LT-153',name:'Joseph Dredd'},{cs:'LT-162',name:'John Shepard'},{cs:'LT-169',name:'Frank Hoight'},{cs:'LT-180',name:'Nora Cipriano'},
  {cs:'S-201',name:'Alexander Cappella'},{cs:'S-202',name:'Justin North'},{cs:'S-203',name:'Max Harris'},{cs:'S-204',name:'Faye Howell'},{cs:'S-205',name:'Timothy Martinez Jr'},{cs:'S-206',name:'Louie Herrett'},{cs:'S-207',name:'Romeo Vanderford'},{cs:'S-218',name:'Ben Asher'},{cs:'S-220',name:'Wes North'},{cs:'S-227',name:'Lando Doe'},{cs:'S-229',name:'Neon Cash'},{cs:'S-239',name:'Dawid Odison'},{cs:'S-255',name:"Brian O’connor II"},
  {cs:'CO-301',name:'Saylor Ray'},{cs:'CO-303',name:'Jason Wescott'},{cs:'CO-305',name:'Julius Barry'},{cs:'CO-309',name:'Eddie Irwin'},{cs:'CO-310',name:'Belle French'},{cs:'CO-311',name:'Jay Walken'},{cs:'CO-312',name:'Timmy Hunter'},{cs:'CO-313',name:'Doug Grayves'},{cs:'CO-320',name:'Bo Stabler'},{cs:'CO-321',name:'Travis Brewer'},{cs:'CO-331',name:'Enzo Knight'},{cs:'CO-333',name:'Del Powers'},{cs:'CO-350',name:'Stevo Mayte'},{cs:'CO-360',name:'Matthew Ramirez'},{cs:'CO-369',name:'James Middleton'},{cs:'CO-383',name:'Skeeter Woodhouse'},{cs:'CO-395',name:'Ronny Roman'},
  {cs:'SO-401',name:'Finley Maximoff'},{cs:'SO-402',name:'Jerry Ward'},{cs:'SO-404',name:'Joseph Randy'},{cs:'SO-405',name:'Sebastian Collinsworth'},{cs:'SO-406',name:'Ricky Mathers'},{cs:'SO-407',name:'Sonny Sullivan'},{cs:'SO-408',name:'Albus Davies'},{cs:'SO-410',name:'Clint Morris'},{cs:'SO-411',name:'Scarlett Rain'},{cs:'SO-412',name:'Steven Wet'},{cs:'SO-413',name:'Ralph Garza'},{cs:'SO-414',name:'Aezlyn Soria'},{cs:'SO-416',name:'Austin Crockett'},{cs:'SO-419',name:'Kaleb Axel'},{cs:'SO-420',name:'Juniper Rowan'},{cs:'SO-429',name:'Dale Shields'},{cs:'SO-440',name:'Dempsey Watson'},{cs:'SO-443',name:'Street Frost'},{cs:'SO-444',name:'Adam Ahmed'},{cs:'SO-450',name:'Ava Valentine'},{cs:'SO-459',name:'Jimmy Hoxton'},{cs:'SO-469',name:'Jimmy Boudreaux'},{cs:'SO-485',name:'Ralph Lawrence'},{cs:'SO-488',name:'Marc Chevy'},{cs:'SO-497',name:'Michigan Silver'},{cs:'SO-498',name:'Jeremie Rodriguez Valentine'},
  {cs:'O-501',name:'Casey Leclair'},{cs:'O-505',name:'Justin Bleacher'},{cs:'O-507',name:'Phil Eldwood'},{cs:'O-509',name:'Jacob Page'},{cs:'O-510',name:'Tommy Thibodeaux'},{cs:'O-511',name:'Eevee Hunter'},{cs:'O-520',name:'Lela Law'},{cs:'O-521',name:'Aileen Callahan'},{cs:'O-525',name:'Davie Smith'},{cs:'O-530',name:'Aurora Bordeaux'},{cs:'O-542',name:'Fredrick Oxmall'},{cs:'O-545',name:'Michael Price'},{cs:'O-550',name:'Lexie Rivers'},{cs:'O-555',name:'Peter Dinklage'},{cs:'O-559',name:'Misty Meanor'},
  {cs:'PO-601',name:'Tommy Redwood'},{cs:'PO-612',name:'Anakin Skywalker'},{cs:'PO-616',name:'Derrick Stones'},{cs:'PO-617',name:'Peach Cobbler'},{cs:'PO-627',name:'Lily Cappella-beltz'},{cs:'PO-660',name:'Elliot Grayson'},{cs:'PO-666',name:'Benson Drake'},{cs:'PO-669',name:'Kendrick Carter'},{cs:'PO-670',name:'Ryan Gonzalez'},{cs:'PO-677',name:'Eric Gunter'},{cs:'PO-687',name:'Lewis Gallagher'}
];
const NAME_OPT=(o)=>`${o.name} — ${o.cs}`;
function populateCallsignSelect(sel){ if(!sel) return; sel.innerHTML='<option value="">Select callsign — name…</option>'; OFFICERS.forEach(o=>{const opt=document.createElement('option'); opt.value=o.cs; opt.textContent=`${o.cs} — ${o.name}`; sel.appendChild(opt);}); }
function populateNameSelect(sel){ if(!sel) return; sel.innerHTML=`<option value="">— Select —</option>`; OFFICERS.forEach(o=>{const opt=document.createElement('option'); opt.value=NAME_OPT(o); opt.textContent=NAME_OPT(o); sel.appendChild(opt);}); }

/**************** CALC DATA ****************/
function C(code,name,definition,time,fine,result,points){return {code,name,definition,time,fine,result:parseResult(result),points:points??0};}
function parseResult(r){const arr=(r||'').split(',').map(s=>s.trim()).filter(Boolean);return { raw:arr, per:arr.includes('Per'), seize:arr.includes('Seize') };}
// FULL CHARGES ARRAY — copied from your previous calculator
const CHARGES = "+CHARGES_JSON+";
const ENH = [
  {code:'P.C. 1101', name:'Accessory Before The Fact (ACC-BTF)', multiplier:1.25, note:'Seize'},
  {code:'P.C. 1102', name:'Accessory After The Fact (ACC-ATF)',  multiplier:1.75, note:'Seize'},
  {code:'P.C. 1103', name:'Aiding and Abetting (AAA)',           multiplier:2.00, note:'Seize'},
  {code:'P.C. 1104', name:'Applicability (APP)',                 multiplier:1.00, note:'Per stacking allowed (already handled).'},
  {code:'P.C. 1105', name:'Attempt (ATT)',                       multiplier:2.00, note:'Same punishment as completed offense.'},
  {code:'P.C. 1106', name:'Conspiracy (CON)',                    multiplier:2.00, note:'Same punishment as completed offense.'},
  {code:'P.C. 1107', name:'Soliciting (SOL)',                    multiplier:1.50, note:'Similar punishment as completed offense.'},
  {code:'P.C. 1108', name:'Gang Enhancement (GE)',               multiplier:1.50},
  {code:'P.C. 1109', name:'Protected Persons (PP)',              multiplier:1.40},
  {code:'P.C. 1110', name:'Public Menace (PM)',                  multiplier:1.00, extraMonthsPer:600, count:0, configurable:true},
  {code:'P.C. 1111', name:'Intent to Sell (ITS)',                multiplier:1.50},
  {code:'P.C. 1112', name:'Protected Property (P-Prop)',         multiplier:1.20},
  {code:'P.C. 1113', name:'Deface Firearm (DFF)',                multiplier:1.00, note:'Use with P.C. 906 if applicable.'}
];

/**************** CALC STATE/RENDER/REPORT (unchanged from your working calc) ****************/
const state={selected:[], enh:new Set(), pmCount:0, officer:'', suspect:''};
const $=s=>document.querySelector(s);
function currency(n){return `$${Number(n||0).toLocaleString()}`} function months(n){return (n==='HUT')? 'HUT' : `${n} months`}
function renderCatalog(){ const q=$('#search').value.trim().toLowerCase(); const list=$('#catalog'); list.innerHTML=''; CHARGES.filter(c=>!q||c.code.toLowerCase().includes(q)||c.name.toLowerCase().includes(q)).forEach(c=>{ const row=document.createElement('div'); row.className='charge-item'; const left=document.createElement('div'); left.innerHTML=`<div><span class="code">${c.code}</span> — ${c.name}</div><div class="def">${c.definition}</div>`; const qty=document.createElement('input'); qty.type='number'; qty.min='1'; qty.value='1'; qty.style.width='70px'; qty.title='Count'; const add=document.createElement('button'); add.className='btn'; add.textContent='Add'; add.onclick=()=>addCharge(c.code,parseInt(qty.value||'1',10)); row.append(left,qty,add); list.appendChild(row); }); }
function addCharge(code,count){ const found=state.selected.find(x=>x.code===code); if(found){found.count+=count;} else {state.selected.push({code,count});} persist(); renderSelected(); }
function removeCharge(code){ state.selected=state.selected.filter(x=>x.code!==code); persist(); renderSelected(); }
function renderEnh(){ const box=document.getElementById('enhancements'); box.innerHTML=''; ENH.forEach(e=>{ const row=document.createElement('div'); row.className='card'; const id='enh_'+e.code.replaceAll(' ','_').replaceAll('.','_'); row.innerHTML=`<label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="${id}" ${state.enh.has(e.code)?'checked':''} /><div><div><strong>${e.code}</strong> — ${e.name} <span class="tag">x${(e.multiplier||1).toFixed(2)}</span></div>${e.note?`<div class="muted small">${e.note}</div>`:''}</div></label>`; box.appendChild(row); const ck=row.querySelector('input'); ck.addEventListener('change',()=>{ if(ck.checked) state.enh.add(e.code); else state.enh.delete(e.code); if(e.code==='P.C. 1110'&&ck.checked&&state.pmCount===0) state.pmCount=1; persist(); renderSelected(); renderEnh();}); if(e.configurable){ const ctrl=document.createElement('div'); ctrl.className='row small'; ctrl.style.marginTop='6px'; ctrl.innerHTML=`<label style="flex:1">Prior serious felonies (PM +600 each)<input type="number" id="pmCount" min="0" value="${state.pmCount||0}" /></label>`; box.appendChild(ctrl); ctrl.querySelector('#pmCount').addEventListener('input',ev=>{ state.pmCount=parseInt(ev.target.value||'0',10); persist(); renderSelected();}); }}); }
function activeEnh(){ return ENH.filter(e=>state.enh.has(e.code)); }
function calcTotals(){ let totalMonths=0,totalFine=0,totalPoints=0,flags=new Set(),hut=false; state.selected.forEach(item=>{ const c=CHARGES.find(x=>x.code===item.code); if(!c) return; const count=item.count; const isHUT=(c.time==='HUT'||c.fine==='HUT'); if(isHUT) hut=true; const baseMonths=(c.time==='HUT')?0:Number(c.time||0)*(c.result.per?count:1); const baseFine=(c.fine==='HUT')?0:Number(c.fine||0)*(c.result.per?count:1); totalMonths+=baseMonths; totalFine+=baseFine; totalPoints+=Number(c.points||0)*(c.result.per?count:1); if(c.result.seize) flags.add('Seize'); }); let mult=1.0; activeEnh().forEach(e=>mult*=(e.multiplier||1)); totalMonths=Math.round(totalMonths*mult); totalFine=Math.round(totalFine*mult); totalPoints=Math.round(totalPoints); const pm=activeEnh().find(e=>e.code==='P.C. 1110'); if(pm&&state.pmCount>0){ totalMonths+=(pm.extraMonthsPer||0)*state.pmCount; } return {months:totalMonths,fine:totalFine,points:totalPoints,hut,flags:[...flags]}; }
function calcAndRenderTotals(){ const t=calcTotals(); document.getElementById('sumTime').textContent=t.hut?'HUT':months(t.months); document.getElementById('sumFine').textContent=currency(t.fine); document.getElementById('sumPoints').textContent=String(t.points); document.getElementById('sumFlags').innerHTML=(t.flags.length?t.flags.map(f=>`<span class=tag>${f}</span>`).join(''):'<span class=muted>None</span>'); }
function renderSelected(){ const area=document.getElementById('selected'); area.innerHTML=''; if(state.selected.length===0){ area.innerHTML='<div class="muted small">No charges selected.</div>'; } state.selected.forEach(item=>{ const c=CHARGES.find(x=>x.code===item.code); if(!c) return; const row=document.createElement('div'); row.className='selected-row'; row.innerHTML=`<div class=code>${c.code}</div><div>${c.name}<div class="muted small">${c.definition}</div></div><input type=number min=1 value="${item.count}" /><div class=small>Time: ${months(c.time)}<br>Fine: ${currency(c.fine)}${c.points?`<br>Points: ${c.points}`:''}</div><div class=small>${c.result.per?'<span class=tag>Per</span>':''}${c.result.seize?'<span class=tag>Seize</span>':''}</div><button class=btn title=Remove>✕</button>`; const qty=row.querySelector('input'); qty.addEventListener('input',()=>{ item.count=Math.max(1,parseInt(qty.value||'1',10)); persist(); calcAndRenderTotals(); buildReport();}); row.querySelector('button').addEventListener('click',()=>removeCharge(item.code)); area.appendChild(row); }); calcAndRenderTotals(); buildReport(); }
function buildReport(){ const t=calcTotals(); const lines=[]; if(state.officer) lines.push(`Officer: ${state.officer}`); if(state.suspect) lines.push(`Suspect: ${state.suspect}`); if(state.officer||state.suspect) lines.push(''); lines.push('Charges:'); state.selected.forEach(item=>{ const c=CHARGES.find(x=>x.code===item.code); if(!c) return; const qty=item.count; const per=c.result.per?` x${qty}`:''; const info=[`Time ${months(c.time)}`,`Fine ${currency(c.fine)}`]; if(c.points) info.push(`Points ${c.points}${c.result.per?` x${qty}`:''}`); const flags=[]; if(c.result.per) flags.push('Per'); if(c.result.seize) flags.push('Seize'); lines.push(`- ${c.code} — ${c.name}${per} (${info.join(', ')}${flags.length?`; ${flags.join(' / ')}`:''})`); }); if(state.enh.size){ lines.push(''); lines.push('Enhancements:'); activeEnh().forEach(e=>{ if(e.code==='P.C. 1110'){ lines.push(`- ${e.code} — ${e.name} (x${(e.multiplier||1).toFixed(2)}${state.pmCount?`; +${600} months × ${state.pmCount}`:''})`);} else { lines.push(`- ${e.code} — ${e.name} (x${(e.multiplier||1).toFixed(2)})`);} }); } lines.push(''); const flagLine=t.flags.length?`Flags: ${t.flags.join(', ')}`:'Flags: None'; const totTime=t.hut?'HUT':months(t.months); lines.push(`Total Time: ${totTime}`); lines.push(`Total Fine: ${currency(t.fine)}`); lines.push(`Total Points: ${t.points}`); lines.push(flagLine); document.getElementById('report').value=lines.join('
'); }
function persist(){ const data={selected:state.selected, enh:[...state.enh], pmCount:state.pmCount, officer:state.officer, suspect:state.suspect}; localStorage.setItem('chargeCalc',JSON.stringify(data)); }
function load(){ const s=localStorage.getItem('chargeCalc'); if(s){ try{const d=JSON.parse(s); if(d.selected) state.selected=d.selected; if(d.enh) state.enh=new Set(d.enh); if(Number.isInteger(d.pmCount)) state.pmCount=d.pmCount; state.officer=d.officer||''; state.suspect=d.suspect||'';}catch{} } }
function applyURLCalc(){ const p=new URLSearchParams(location.search); const codes=p.get('codes'); const enh=p.get('enh'); const off=p.get('officer'); const sus=p.get('suspect'); if(off) state.officer=off; if(sus) state.suspect=sus; if(codes){ state.selected=[]; codes.split(',').forEach(tok=>{ const [raw,qty]=tok.split('x'); const code=raw.startsWith('P.C.')?raw:`P.C. ${raw}`; if(CHARGES.find(c=>c.code===code)) state.selected.push({code,count:Math.max(1,parseInt(qty||'1',10))}); }); } if(enh){ state.enh=new Set(); enh.split(',').forEach(e=>{ const code=e.startsWith('P.C.')?e:`P.C. ${e}`; if(ENH.find(x=>x.code===code)) state.enh.add(code); }); } const pmc=p.get('pm'); if(pmc) state.pmCount=Math.max(0,parseInt(pmc,10)||0); }
function shareLinkCalc(){ const parts=[]; if(state.selected.length){ const c=state.selected.map(x=>`${x.code.replace('P.C. ','')}x${x.count}`).join(','); parts.push(`codes=${encodeURIComponent(c)}`);} if(state.enh.size){ const e=[...state.enh].map(x=>x.replace('P.C. ','')); parts.push(`enh=${encodeURIComponent(e.join(','))}`);} if(state.pmCount) parts.push(`pm=${state.pmCount}`); if(state.officer) parts.push(`officer=${encodeURIComponent(state.officer)}`); if(state.suspect) parts.push(`suspect=${encodeURIComponent(state.suspect)}`); const url=`${location.origin}${location.pathname}?${parts.join('&')}#calc`; navigator.clipboard.writeText(url).then(()=>alert('Shareable link copied')).catch(()=>prompt('Copy link:',url)); }

/**************** ROBBERY ****************/
const ENDINGS=[ 'Units lost eyes | Escaped','Suspects caught | General Ending','Surrendered | General Ending','Got out of vehicle | Ran on foot | Caught','Got out of vehicle | Ran on foot | Escaped','Vehicle disabled | Ran on foot | Caught','Vehicle disabled | Ran on foot | Escaped','Vehicle disabled | Vehicle swap | Caught','Vehicle disabled | Vehicle swap | Escaped','Vehicle disabled | Surrendered','Vehicle Tires Popped | Ran on foot | Caught','Vehicle Tires Popped | Ran on foot | Escaped','Vehicle Tires Popped | Surrendered','Vehicle boxed in | Ran on foot | Caught','Vehicle boxed in | Ran on foot | Escaped','Vehicle boxed in | Surrendered','Attempted Vehicle swap | Caught','Vehicle swap x1 | Caught','Vehicle swap x1 | Escaped','Vehicle swap x2 | Caught','Vehicle swap x2 | Escaped','Vehicle swap x3 | Caught','Vehicle swap x3 | Escaped','Bike swap | Caught','Bike swap | Escaped','Vehicle ran out of fuel | Ran on foot | Transfer vehicle | Caught','Vehicle ran out of fuel | Ran on foot | Transfer vehicle | Escaped','Vehicle ran out of fuel | Ran on foot | Caught','Vehicle ran out of fuel | Ran on foot | Escaped','Vehicle ran out of fuel | Surrendered','Vehicle turtled | Ran on foot | Transfer vehicle | Caught','Vehicle turtled | Ran on foot | Transfer vehicle | Escaped','Vehicle turtled | Ran on foot | Caught','Vehicle turtled | Ran on foot | Escaped','Vehicle turtled | Surrendered','Vehicle Stuck | Ran on foot | Caught','Vehicle Stuck | Ran on foot | Escaped','Vehicle Stuck | Surrendered','Vehicle was sent into water | Caught','Vehicle was sent into water | Escaped','Vehicle blew up','Vehicle took a jump | Escaped','Suspects opened fire from the vehicle | Caught','Suspects opened fire from the vehicle | Escaped','Turned into a shootout | All Caught','Turned into a shootout | All Escaped','Secondary Vehicle Blocked Units | Escaped','Vehicle 10-50 | Suspects went down','Bike disabled | Ran on foot | Caught','Bike disabled | Ran on foot | Escaped','Bike disabled | Surrendered','Fell off bike | Ran on foot | Caught','Fell off bike | Ran on foot | Escaped','Fell off bike | Vehicle Swap | Caught','Fell off bike | Vehicle Swap | Escaped','Fell off bike | Surrendered','Suspects declared Code Red' ];
const RF=JSON.parse(localStorage.getItem('robbery_v2')||'{}');
function syncOfficerAcross(val){ const calcInput=document.getElementById('officer'); if(calcInput){ calcInput.value=val; state.officer=val; persist(); buildReport(); } }
function fillOfficerSelect(selId,inputId){ const sel=document.querySelector(selId); populateCallsignSelect(sel); if(RF.officerCS) sel.value=RF.officerCS; sel.onchange=()=>{ const o=OFFICERS.find(x=>x.cs===sel.value); if(!o) return; RF.officerCS=o.cs; RF.officer=`${o.cs} — ${o.name}`; document.querySelector(inputId).value=RF.officer; persistRF(); buildRF(); syncOfficerAcross(RF.officer); }; }
function populatePursuitDropdowns(){ ['sceneCmd','negotiator','hostageBack','primary','primaryPass','secondary','secondaryPass','tertiary','tertiaryPass','parallel','parallelPass'].forEach(id=>populateNameSelect(document.getElementById(id))); ['sceneCmd','negotiator','hostageBack','primary','primaryPass','secondary','secondaryPass','tertiary','tertiaryPass','parallel','parallelPass'].forEach(id=>{ if(RF[id]) document.getElementById(id).value=RF[id]; document.getElementById(id).addEventListener('change',ev=>{ RF[id]=ev.target.value; persistRF(); buildRF();}); }); }
function toggleWhich(){ const f=document.getElementById('whichFleeca'), s=document.getElementById('which247'); f.style.display=(RF.robType==='Fleeca Bank')?'block':'none'; s.style.display=(RF.robType==='24/7 Store')?'block':'none'; }
function initRobType(){ if(RF.robType){ const r=[...document.getElementsByName('robType')].find(x=>x.value===RF.robType); if(r) r.checked=true; } Array.from(document.getElementsByName('robType')).forEach(r=>r.addEventListener('change',()=>{ RF.robType=r.value; persistRF(); toggleWhich(); buildRF(); })); }
function persistRF(){ localStorage.setItem('robbery_v2',JSON.stringify(RF)); }
function bindRF(){ function bind(id){ const el=document.querySelector(id); if(!el) return; el.value=RF[id.slice(1)]||''; el.addEventListener('input',ev=>{ RF[id.slice(1)]=ev.target.value; persistRF(); buildRF(); if(id==='#robOfficer') syncOfficerAcross(RF.officer); }); }
  function bindSel(id){ const el=document.querySelector(id); if(!el) return; if(RF[id.slice(1)]) el.value=RF[id.slice(1)]; el.addEventListener('change',ev=>{ RF[id.slice(1)]=ev.target.value; persistRF(); buildRF();}); }
  function bindChk(id){ const el=document.querySelector(id); if(!el) return; el.checked=!!RF[id.slice(1)]; el.addEventListener('change',()=>{ RF[id.slice(1)]=el.checked; persistRF(); buildRF();}); }
  bind('#robOfficer'); ['#robInside','#robOutside','#hostages','#processedAt','#hospital','#ending'].forEach(bindSel); ['#bike','#air1','#air1Copilot','#demandOther','#vehDesc','#vehColor','#vehPlate','#vehRegTo','#endingCustom'].forEach(bind); ['#caughtOnly','#medNeeded','#fleeHospital','#pleadNC'].forEach(bindChk);
  Array.from(document.querySelectorAll('.demand')).forEach(cb=>{ cb.checked=(RF.demands||[]).includes(cb.value); cb.addEventListener('change',()=>{ const set=new Set(RF.demands||[]); if(cb.checked) set.add(cb.value); else set.delete(cb.value); RF.demands=[...set]; persistRF(); buildRF();}); }); }
function buildRF(){ const lines=[]; if(RF.officer) lines.push(`Your Callsign & Name: ${RF.officer}`); if(RF.sceneCmd||RF.negotiator||RF.hostageBack){ lines.push(''); lines.push('Assignment:'); if(RF.sceneCmd) lines.push(`- Scene command: ${RF.sceneCmd}`); if(RF.negotiator) lines.push(`- Negotiator: ${RF.negotiator}`); if(RF.hostageBack) lines.push(`- Who stayed back for hostage: ${RF.hostageBack}`); }
  const purs=[['Primary',RF.primary,RF.primaryPass],['Secondary',RF.secondary,RF.secondaryPass],['Tertiary',RF.tertiary,RF.tertiaryPass],['Parallel',RF.parallel,RF.parallelPass]]; const extras=[['Bike-Unit',RF.bike],['Air-1',RF.air1],['Co-Pilot',RF.air1Copilot]]; if(purs.some(x=>x[1]||x[2])||extras.some(x=>x[1])){ lines.push(''); lines.push('Pursuit Order:'); purs.forEach(([l,u,p])=>{ if(u||p) lines.push(`${l}: ${u||'—'}${p?`  |  Passenger: ${p}`:''}`);}); if(RF.bike) lines.push(`Bike-Unit (Optional): ${RF.bike}`); if(RF.air1) lines.push(`Air-1 (Optional): ${RF.air1}`); if(RF.air1Copilot) lines.push(`Co-Pilot (Optional): ${RF.air1Copilot}`); }
  if(RF.robType){ lines.push(''); lines.push(`Robbery Type: ${RF.robType}`); if(RF.robType==='Fleeca Bank'){ if(RF.whichFleeca) lines.push(`Which Fleeca: ${RF.whichFleeca}`); else lines.push('Which Fleeca: **Enter bank name here**'); } if(RF.robType==='24/7 Store'){ if(RF.which247) lines.push(`Which 24/7: ${RF.which247}`); else lines.push('Which 24/7: **Enter store name here**'); } }
  if(RF.robInside||RF.robOutside||RF.hostages){ lines.push(''); lines.push(`Numbers: Robbers on inside: ${RF.robInside||'—'} | Robbers on outside: ${RF.robOutside||'—'} | Hostages: ${RF.hostages||'—'}`); }
  const demands=[...(RF.demands||[])]; if(RF.demandOther) demands.push(RF.demandOther); if(demands.length){ lines.push(''); lines.push('Demands:'); demands.forEach(d=>lines.push(`- ${d}`)); }
  if(RF.vehDesc||RF.vehColor||RF.vehPlate||RF.vehRegTo){ lines.push(''); lines.push('Vehicle Information:'); if(RF.vehDesc) lines.push(`- Description: ${RF.vehDesc}`); if(RF.vehColor) lines.push(`- Color: ${RF.vehColor}`); if(RF.vehPlate) lines.push(`- Plate: ${RF.vehPlate}`); if(RF.vehRegTo) lines.push(`- Registered To: ${RF.vehRegTo}`); }
  const endingLine=(RF.endingCustom&&RF.endingCustom.trim())?RF.endingCustom.trim():(RF.ending||''); if(endingLine||RF.caughtOnly){ lines.push(''); lines.push('How did the chase end?'); if(endingLine) lines.push(`- ${endingLine}`); if(RF.caughtOnly) lines.push('- Check this once they have been caught only!'); }
  if(RF.medNeeded||RF.medSus||RF.medCop||RF.hospital||RF.fleeHospital){ lines.push(''); lines.push('Medical Attention... - Was it needed?'); if(RF.medNeeded) lines.push('- Yes'); if(RF.medSus) lines.push(`- Suspects: ${RF.medSus}`); if(RF.medCop) lines.push(`- Police: ${RF.medCop}`); if(RF.hospital) lines.push(`Which hospital? ${RF.hospital}`); if(RF.fleeHospital) lines.push('- Attempted to flee at hospital'); }
  if(RF.processedAt||RF.pleadNC){ lines.push(''); lines.push('Processed at...'); if(RF.processedAt) lines.push(`- ${RF.processedAt}`); if(RF.pleadNC) lines.push('- Plead no contest'); }
  document.getElementById('robReport').value=lines.join('
'); }
function initRobberyTab(){ populateCallsignSelect(document.getElementById('officerSelect')); populateCallsignSelect(document.getElementById('robOfficerSel')); fillOfficerSelect('#officerSelect','#officer'); fillOfficerSelect('#robOfficerSel','#robOfficer'); populatePursuitDropdowns(); const e=document.getElementById('ending'); ENDINGS.forEach(x=>{ const opt=document.createElement('option'); opt.textContent=x; e.appendChild(opt);}); if(RF.ending) e.value=RF.ending; e.onchange=()=>{ RF.ending=e.value; persistRF(); buildRF(); }; initRobType(); toggleWhich(); bindRF(); document.getElementById('robCopy').addEventListener('click',()=>navigator.clipboard.writeText(document.getElementById('robReport').value).catch(()=>{})); document.getElementById('robPrint').addEventListener('click',()=>window.print()); document.getElementById('robShare').addEventListener('click',()=>{ const parts=[]; const enc=v=>encodeURIComponent(v); if(RF.officerCS) parts.push(`officerCS=${enc(RF.officerCS)}`); else if(RF.officer) parts.push(`officer=${enc(RF.officer)}`); const map=['sceneCmd','negotiator','hostageBack','primary','primaryPass','secondary','secondaryPass','tertiary','tertiaryPass','parallel','parallelPass','bike','air1','air1Copilot','robType','whichFleeca','which247','robInside','robOutside','hostages','demandOther','vehDesc','vehColor','vehPlate','vehRegTo','ending','endingCustom','processedAt']; map.forEach(k=>{ if(RF[k]) parts.push(`${k}=${enc(RF[k])}`); }); if(RF.caughtOnly) parts.push('caughtOnly=1'); if(RF.medNeeded) parts.push('medNeeded=1'); if(RF.fleeHospital) parts.push('fleeHospital=1'); if(RF.pleadNC) parts.push('pleadNC=1'); if((RF.demands||[]).length) parts.push(`demands=${enc((RF.demands||[]).join('|'))}`); const url=`${location.origin}${location.pathname}?${parts.join('&')}#rob`; navigator.clipboard.writeText(url).then(()=>alert('Shareable link copied')).catch(()=>prompt('Copy link:',url)); }); buildRF(); }

/**************** TABS + EVENTS ****************/
const tabs=document.querySelectorAll('.tab'); const views={calc:document.querySelector('#tab-calc'),rob:document.querySelector('#tab-rob')};
tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); views.calc.style.display=t.dataset.tab==='calc'?'block':'none'; views.rob.style.display=t.dataset.tab==='rob'?'block':'none'; location.hash=t.dataset.tab; }));
function applyHashTab(){ if(location.hash==='#rob'){ tabs[1].click(); } else { tabs[0].click(); } }

/**************** INIT ****************/
// CALC
load(); applyURLCalc(); renderCatalog(); renderEnh(); document.getElementById('officer').value=state.officer||''; document.getElementById('suspect').value=state.suspect||''; renderSelected();
// CALC events
document.getElementById('search').addEventListener('input',renderCatalog); document.getElementById('copy').addEventListener('click',()=>navigator.clipboard.writeText(document.getElementById('report').value).catch(()=>{})); document.getElementById('print').addEventListener('click',()=>window.print()); document.getElementById('clearAll').addEventListener('click',()=>{ state.selected=[]; state.enh.clear(); state.pmCount=0; persist(); renderSelected(); renderEnh(); }); document.getElementById('shareLink').addEventListener('click',shareLinkCalc); document.getElementById('officer').addEventListener('input',e=>{ state.officer=e.target.value; persist(); buildReport(); }); document.getElementById('suspect').addEventListener('input',e=>{ state.suspect=e.target.value; persist(); buildReport(); });
// ROB
initRobberyTab();
// TAB hash
applyHashTab(); window.addEventListener('hashchange',applyHashTab);
</script>
</body>
</html>
